distinct(sub_n_new,tdo,display,probe,tdd_5,tdd_9,tdd_14)
# number of unique trials
n_unique <- nrow(critical_unique)
# data for stan
stan_data <- list(
n_subs=n_subs, # N
n_trials=nrow(critical_for_model),
sub_n_new=critical_for_model$sub_n_new,
tdo=critical_for_model$tdo,
display=critical_for_model$display,
probe=critical_for_model$probe,
tdd_5=critical_for_model$tdd_5,
tdd_9=critical_for_model$tdd_9,
tdd_14=critical_for_model$tdd_14,
discrim=critical_for_model$discrim,
n_trials_unique=n_unique,
sub_n_new_unique=critical_unique$sub_n_new,
tdo_unique=critical_unique$tdo,
display_unique=critical_unique$display,
probe_unique=critical_unique$probe,
tdd_5_unique=critical_unique$tdd_5,
tdd_9_unique=critical_unique$tdd_9,
tdd_14_unique=critical_unique$tdd_14
)
# controls
debug_model <- F # whether or not we're testing the model to make sure stan code works
prefix <- "m17" # which model iteration
model_dir <- path(here("analyses","stan",prefix)) # stan files / save directory
stan_model_code <- path(model_dir,glue("{prefix}.stan")) # model code
fit_file <- path(model_dir,glue("{prefix}_fit.RData")) # name of our resulting fit object
if(debug_model){
n_iter <- 100
n_core <- 1
n_chain <- 2
n_warm <- 10
to_save <- F
}else{
# number of iterations for each model per core (for MCMC)
n_iter <- 5000
n_chain <- 5
n_core <- 10
}
if(!file_exists(fit_file) | debug_model){
model_compiled <- stan_model(stan_model_code)
fit <- sampling(model_compiled,
data=stan_data,
chains=n_chain,
cores=n_core,
iter=n_iter,
control=list(adapt_delta=.95))
if(!debug_model) save(fit,file=fit_file)
diagnostics <- get_sampler_params(fit)
if(!debug_model) save(diagnostics, file=path(model_dir,glue("{prefix}_diag.RData")))
fit_summary <- summary(fit,probs=c(.025,.975))
if(!debug_model) save(fit_summary, file=path(model_dir,glue("{prefix}_summary.RData")))
}else{
load(fit_file)
}
# check modeling ===============================================================================
check_energy(fit)
color_scheme_set("red")
# get model predictions ================================================================================================================================================
p <- extract(fit, pars="p")$p
if(!debug_model) save(p,file=path(model_dir,glue("{prefix}_p.RData")))
# convert p to data frame and clean
pd <- as.data.frame(t(p))
colnames(pd) <- paste0("iter_",1:ncol(pd))
pd1 <- bind_cols(critical_unique,pd) %>%
pivot_longer(cols=contains("iter"),values_to = "p",names_to = "iter") %>%
mutate(tdd=case_when(
tdd_5==1~5,
tdd_9==1~9,
tdd_14==1~14,
T~2
),
tdo=case_when(
tdo==1~"w",
tdo==0~"h"
),
display=case_when(
display==1~"horizontal",
display==0~"triangle"
),
probe=case_when(
probe==1~"td",
probe==0~"dc"
))
head(pd1)
colnames(pd1)
# subject level predictions ========================================================================================================================
pd1 %>%
group_by(sub_n_new, probe, tdd, display, iter) %>%
summarise(m=mean(p))
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p),
l=hdi(p)[,1],
u=hdi(p)[,2]) %>%
ungroup()
distinct(pd1, sub_n_new, probe, tdd, display)
View(model_sub_preds)
distinct(pd1, sub_n_new, probe, tdd, display, iter)
model_sub_preds=left_join(model_sub_preds,subs_key)
model_sub_preds$source <- "model"
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(p=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds)
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds)
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
select(-sub_n_new) %>%
pivot_wider(names_from = source, values_from = c(m,l,u))
View(model_sub_preds)
model_sub_preds$source <- "model"
View(model_sub_preds)
x=critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
select(-sub_n_new) %>%
pivot_wider(names_from = source, values_from = c(m,l,u))
View(x)
hdi(rnorm(100)[,1])
hdi(rnorm(100))
hdi(rnorm(100))[,1]
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p),
l=hdi(p)[,1],
u=hdi(p)[,2]) %>%
ungroup() %>%
left_join(subs_key) %>%
mutate(source="model")
View(model_sub_preds)
m=filter(model_sub_preds, sub_n_new==1)
m=filter(pd1, sub_n_new==1)
View(m)
m  %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p) )
m  %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p),
l=hdi(p)[,1])
hdi(rnorm(100))[,1]
hdi(rnorm(100))[,2]
summarise(m=mean(p) %>%
)
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p)) %>%
ungroup() %>%
left_join(subs_key) %>%
mutate(source="model")
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
select(-sub_n_new) %>%
pivot_wider(names_from = source, values_from = m)
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p)) %>%
ungroup() %>%
left_join(subs_key) %>%
mutate(source="model")
View(model_sub_preds)
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
select(-sub_n_new) %>%
pivot_wider(names_from = source, values_from = m)
View(model_sub_preds)
model_sub_preds %>% filter(sub_n==49)
critical_1
critical_1$probe
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p)) %>%
ungroup() %>%
left_join(subs_key) %>%
mutate(source="model",
probe=as.factor(probe))
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
select(-sub_n_new) %>%
pivot_wider(names_from = source, values_from = m)
critical_1$tdd
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p)) %>%
ungroup() %>%
left_join(subs_key) %>%
mutate(source="model",
across(c(probe,display,tdd),as.factor))
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
select(-sub_n_new) %>%
pivot_wider(names_from = source, values_from = m)
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p)) %>%
ungroup() %>%
left_join(subs_key) %>%
mutate(source="model",
across(c(probe,display),as.factor))
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
select(-sub_n_new) %>%
pivot_wider(names_from = source, values_from = m)
x=critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
select(-sub_n_new) %>%
pivot_wider(names_from = source, values_from = m)
View(x)
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds)
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p)) %>%
ungroup() %>%
left_join(subs_key) %>%
mutate(source="model",
across(c(probe,display),as.factor)) %>%
select(-sub_n_new)
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
select(-sub_n_new) %>%
pivot_wider(names_from = source, values_from = m)
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
pivot_wider(names_from = source, values_from = m)
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(model=mean(p)) %>%
ungroup() %>%
left_join(subs_key)
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(data=mean(discrim)) %>%
ungroup() %>%
left_join(model_sub_preds)
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(model=mean(p)) %>%
ungroup() %>%
left_join(subs_key) %>%
select(-sub_n_new)
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(data=mean(discrim)) %>%
ungroup() %>%
left_join(model_sub_preds)
View(model_sub_preds)
critical_1 %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(data=mean(discrim)) %>%
ungroup() %>%
left_join(model_sub_preds)
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(m=mean(p)) %>%
ungroup() %>%
left_join(subs_key) %>%
mutate(source="model",
across(c(probe,display),as.factor))
critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup() %>%
mutate(source="data") %>%
bind_rows(model_sub_preds) %>%
select(-sub_n_new) %>%
pivot_wider(names_from = source, values_from = m)
unique(model_sub_preds$tdd)
unique(critical_1 %>% mutate(tdd=as.numeric(as.character(tdd))*100))$tdd
View(model_sub_preds)
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
group_by(sub_n_new, probe, tdd, display) %>%
summarise(model=mean(p)) %>%
ungroup() %>%
left_join(subs_key) %>%
mutate(across(c(probe,display),as.factor)) %>%
select(-sub_n_new)
critical_sub_data <- critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(m=mean(discrim)) %>%
ungroup()
head(model_sub_preds)
head(critical_sub_data)
critical_sub_data <- critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(data=mean(discrim)) %>%
ungroup()
head(critical_sub_data)
head(model_sub_preds)
full_join(critical_sub_data, model_sub_preds)
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
left_join(subs_key) %>%
group_by(sub_n, probe, tdd, display) %>%
summarise(model=mean(p)) %>%
ungroup() %>%
mutate(across(c(probe,display),as.factor))
critical_sub_data <- critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(data=mean(discrim)) %>%
ungroup()
full_join(critical_sub_data, model_sub_preds)
distinct(model_sub_preds, display, probe, tdd)
distinct(model_sub_preds, display, probe, tdd, sub_n)
distinct(critical_sub_data, display, probe, tdd, sub_n)
full_join(critical_sub_data, model_sub_preds)
# subject level predictions ========================================================================================================================
model_sub_preds <- pd1 %>%
left_join(subs_key) %>%
group_by(sub_n, probe, tdd, display) %>%
summarise(model=mean(p,na.rm = T)) %>%
ungroup() %>%
mutate(across(c(probe,display),as.factor))
critical_sub_data <- critical_1 %>%
mutate(tdd=as.numeric(as.character(tdd))*100) %>%
group_by(sub_n,display,probe,tdd) %>%
summarise(data=mean(discrim)) %>%
ungroup()
full_join(critical_sub_data, model_sub_preds)
rm(list=ls())
library(fs)
library(here)
library(tidyverse)
library(rstan)
library(loo)
load(here("analyses/stan/m14/m14_fit.RData"))
m14 <- fit
load(here("analyses/stan/m14/m14_fit.RData"))
m17 <- fit
rm(fit)
?loo_compare
load(here("analyses/stan/m14/m17_fit.RData"))
m17 <- fit
rm(list=ls())
library(fs)
library(here)
library(tidyverse)
library(rstan)
library(loo)
load(here("analyses/stan/m14/m14_fit.RData"))
m14 <- fit
load(here("analyses/stan/m17/m17_fit.RData"))
m17 <- fit
rm(fit)
m14_loo <- loo(m14)
?loo
m14_loo <- loo(m14, pars="lp__")
m14_waic <- waic(m14, pars="lp__")
?waic
help("loo.array", package = "loo")
m14_loo <- rstan::loo(m14)
m14_loo <- rstan::loo(m14,pars="lp__")
m17_loo <- rstan::loo(m17,pars="lp__")
comp <- loo_compare(m14_loo, m17_loo)
loo.stanfit <-
function(x,
pars = "log_lik",
...,
save_psis = FALSE,
cores = getOption("mc.cores", 1)) {
stopifnot(length(pars) == 1L)
LLarray <- loo::extract_log_lik(stanfit = x,
parameter_name = pars,
merge_chains = FALSE)
r_eff <- loo::relative_eff(x = exp(LLarray), cores = cores)
loo::loo.array(LLarray,
r_eff = r_eff,
cores = cores,
save_psis = save_psis)
}
loo.stanfit <-
function(x,
pars = "lp__",
...,
save_psis = FALSE,
cores = getOption("mc.cores", 1)) {
stopifnot(length(pars) == 1L)
LLarray <- loo::extract_log_lik(stanfit = x,
parameter_name = pars,
merge_chains = FALSE)
r_eff <- loo::relative_eff(x = exp(LLarray), cores = cores)
loo::loo.array(LLarray,
r_eff = r_eff,
cores = cores,
save_psis = save_psis)
}
m14_loo <- loo,stan_fit(m14)
m14_loo <- loo.stan_fit(m14)
loo.stanfit <-
function(x,
pars = "lp__",
...,
save_psis = FALSE,
cores = getOption("mc.cores", 1)) {
stopifnot(length(pars) == 1L)
LLarray <- loo::extract_log_lik(stanfit = x,
parameter_name = pars,
merge_chains = FALSE)
r_eff <- loo::relative_eff(x = exp(LLarray), cores = cores)
loo::loo.array(LLarray,
r_eff = r_eff,
cores = cores,
save_psis = save_psis)
}
m14_loo <- loo.stan_fit(m14)
m14_loo <- loo.stanfit(m14)
m17_loo <- loo.stanfit(m17)
comp <- loo_compare(m14_loo, m17_loo)
m14_loo
loo.stanfit <-
function(x,
pars = "log_lik",
...,
save_psis = FALSE,
cores = getOption("mc.cores", 1)) {
stopifnot(length(pars) == 1L)
LLarray <- loo::extract_log_lik(stanfit = x,
parameter_name = pars,
merge_chains = FALSE)
r_eff <- loo::relative_eff(x = exp(LLarray), cores = cores)
loo::loo.array(LLarray,
r_eff = r_eff,
cores = cores,
save_psis = save_psis)
}
m14_loo <- loo,stan_fit(m14)
m14_loo <- loo.stanfit(m14)
